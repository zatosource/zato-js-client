<!doctype html>
<html>
<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

  <script type="text/javascript">

/*
   A Zato WebSocket client which knows how to:

   * Establish long-running connections
   * Invoke services
   * Subscribe to pub/sub messages
   * Unsubscribe from pub/sub
   * Resume subscriptions
*/
class WSXClient {


  constructor() {

    // Client ID -> a random string
    this.client_id = null;

    // Client name -> human-readable
    this.client_name = null;

    // WSX address to connect to
    this.address = null;

    // Username to log in with
    this.username = null;

    // Password to log in with
    this.password = null;

    // Zato WSX token that we will be using once logged in
    this.token = '<invalid>';

    // The underlying WebSocket object
    this.impl = null;

    // A dictionary of msg_id objects to which we expect a response
    this.response_map = {};

    // How many milliseconds to wait for a response from Zato by default
    this.default_wait_time = 500;

    // A callback to invoke after the connection is established
    this.after_connected = null;

    // Are we already connected to Zato?
    this._is_connected = false;
  }

  connect() {
    console.log('Connecting to '+ this.address);

    // Establish a new connection
    this.impl = new WebSocket(this.address);

    // Assign a callback that will obtain a session token
    this.impl.onopen = this.on_wsx_open.bind(this);

    // A callback invoked for each message received from the server
    this.impl.onmessage = this.on_wsx_message.bind(this);

    // Set a flag signalling that we are connected now
    //this._is_connected = true;

  }

  _set_up_wait_for_connection(attempts) {
    console.log(`Waiting for connection to ${this.address}, attempts left: ${attempts+1}`);
    setTimeout(this.wait_for_connection.bind(this), 1000, attempts);
  }

  wait_for_connection(attempts) {
    if(!this._is_connected) {
      if(attempts < 0) {
        console.log(`Could not connect to ${this.address}`);
      }
      else {
        this._set_up_wait_for_connection(attempts-1);
      }
    }
    else {
      console.log('CONNECTED');
    }
  }

  get_base_message(msg_id) {
    let msg = {}
    msg.meta = {
        'id': msg_id,
        'timestamp': new Date().toISOString(),
    }
    return msg;
  }

  get_create_session_message(msg_id) {

    // Base message to enrich with additional information
    let msg = this.get_base_message(msg_id);

    msg.meta.action = "create-session";

    msg.meta.client_id = this.client_id;
    msg.meta.client_name = this.client_name;

    msg.meta.username = this.username;
    msg.meta.password = this.password;

    return JSON.stringify(msg);
  }

  generate_msg_id() {
    return this.client_name + '.' + Math.random().toString(16);
  }

  send(msg_id, msg, wait_time) {

    // Add msg_id to the response map, signalling thus that we expect a response
    this.response_map[msg_id] = null;

    // Invoke Zato
    this.impl.send(msg);

    // Check if there was a response after a while
    let _after_invoke = function() {
      this.handle_response(msg_id);
    }

    setTimeout(_after_invoke.bind(this), wait_time || this.default_wait_time);
  }

  handle_response(msg_id) {
    const response = this.response_map[msg_id];
    console.log(`Response to ${msg_id} is ${response}`);
  }

  on_wsx_open(e) {
    console.log(`Connected to ${this.address}`)

    // Request a session token now that we have connected
    const msg_id = this.generate_msg_id();
    const msg = this.get_create_session_message(msg_id);
    this.send(msg_id, msg);
  }

  on_wsx_message(e) {

    // Log data received
    console.log(`Message received ${e.data}`);

    // We always expect JSON on input
    const msg = JSON.parse(e.data);

    /* If this is a response, store it for the original caller to be able to find it.
       Otherwise, invoke a callback function to
    */
    if(msg.meta.in_reply_to) {
      this.response_map[msg.meta.in_reply_to] = msg;
    }
    else {
    }
  }

  on_request_received(msg) {
    // This is a default handler for non-responses (i.e. requests)
    // received from Zato servers. It simply logs the message received.
    console.log(`WSX request received ${msg}`);
  }

};

const client_id   = '123.456.789';
const client_name = 'My API Client';
const address     = 'ws://localhost:50100/myapi'
const username    = 'username1';
const password    = 'password1';

// A callback function to be invoked once the client connects to Zato
function after_connected(client) {
  console.log(`Client ${client.client_name} connected to ${client.address} as ${client.username}`);
}

// Create a client instance
let client = new WSXClient();

// Fill out configuration
client.client_id = client_id;
client.client_name = client_name;
client.address = address;
client.username = username;
client.password = password;
client.after_connected = after_connected;

// Connect to Zato
client.connect();

// Connection will established in background so we need to wait for it
client.wait_for_connection(60)

// Invoke a simple services
//client.invoke('zato.ping', {'Hello':'World'});

  </script>
</head>
<body>
</body>
